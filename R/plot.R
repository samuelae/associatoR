#' Plot associations
#'
#' Generate a plot of an \code{associatoR} object.
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import} with targets defined by \link[associatoR]{ar_set_targets}.
#' @param facet_by a \code{character} vector of variable names to generate facets.
#' @param top_n a \code{numeric} scalar
#' @param ... optional \code{logical} comparisons to filter the responses before computing frequencies.
#'
#' @return Returns a \link[ggplot2]{ggplot} plot object.
#'
#' @examples
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets("cues") %>%
#'   plot(facets = "gender", top_n = 10)
#'
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets("cues") %>%
#'   plot(facets = "education", top_n = 10, gender == "female")
#'
#' @method plot associatoR
#' @export

plot.associatoR <- function(associations, facet_by = NULL, top_n = 5, ...) {

  # checks
  check_object(associations)
  chk::chk_superset(names(associations), c("participants", "cues", "responses", "targets"), x_name = "The associatoR object passed to plot.associatoR()")
  if(!chk::vld_null(facet_by)) {chk::chk_subset(facet_by, names(associations$participants))}
  chk::chk_whole_number(top_n)
  chk::chk_gt(top_n, 0)

  # extract names
  target_names = names(associations$targets)
  names(associations$targets) = ifelse(target_names == "target", "target", paste0("target_", target_names))

  # join
  tbl = associations$participants %>%
    dplyr::left_join(associations$responses, by = "id") %>%
    dplyr::left_join(associations$cues, by = "cue") %>%
    dplyr::left_join(associations$targets %>% dplyr::mutate(is_target = TRUE), by = c("response" = "target")) %>%
    dplyr::filter(is_target)

  filters = dplyr::enquos(...)

  tbl = tbl %>%
    dplyr::filter(!!!filters) %>%
    dplyr::select(response, tidyselect::all_of(facet_by)) %>%
    dplyr::group_by_all() %>% # superseded, replace
    dplyr::summarize(n = dplyr::n()) %>%
    dplyr::ungroup()

  if(!is.null(facet_by)) {
    tbl = tbl %>%
      dplyr::group_by_at(-c(1, ncol(.))) %>%
      dplyr::arrange(dplyr::desc(n)) %>%
      dplyr::slice(1:min(top_n, dplyr::n())) %>%
      dplyr::ungroup()
  } else {
    tbl = tbl %>%
      dplyr::arrange(dplyr::desc(n)) %>%
      dplyr::slice(1:min(top_n, dplyr::n())) %>%
      dplyr::ungroup()
  }

  # plot
  tbl %>%
    ggplot2::ggplot(ggplot2::aes(x = n, y = response)) +
    ggplot2::geom_bar(stat = "identity") +
    ggplot2::facet_wrap(facet = facet_by, scales = "free") +
    ggplot2::theme_minimal() +
    ggplot2::labs(y = "Response", x = "Frequency")

  }

#' Plot word clouds
#'
#' Generate word cloud plots of response frequencies for \code{associatoR} object.
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import} with targets defined by \link[associatoR]{ar_set_targets}.
#' @param facet_col name of variable to generate column facets by.
#' @param facet_row name of variable to generate row facets by.
#' @param color_by name of variable used to color the words.
#' @param top_n a \code{integer} value specifying the number of highest frequency words to display.
#' @param ... optional arguments passed on to \link[ggwordcloud]{geom_text_wordcloud}.
#'
#' @return Returns a \link[ggplot2]{ggplot} plot object.
#'
#' @examples
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets("cues") %>%
#'   ar_plot_wordcloud(facet_col = gender,
#'                     top_n = 10,
#'                     color_by = NULL)
#'
#' @export

ar_plot_wordcloud <- function(associations,
                              facet_col = cluster,
                              facet_row = NULL,
                              color_by = cluster,
                              top_n = 30,
                              ...) {

  # checks
  check_object(associations)
  check_targets(associations)

  # capture variables
  facet_row = dplyr::enquo(facet_row)
  facet_col = dplyr::enquo(facet_col)
  color_by = dplyr::enquo(color_by)

  # join
  tbl = associations$responses %>%
    dplyr::left_join(associations$targets, by = c("response" = "target")) %>%
    dplyr::left_join(associations$participants, by = "id") %>%
    dplyr::left_join(associations$cues, by = "cue")

  # count
  counts = tbl %>%
    dplyr::count(!!facet_row, !!facet_col, response) %>%
    dplyr::group_by(!!facet_row, !!facet_col) %>%
    dplyr::top_n(top_n) %>%
    dplyr::ungroup() %>%
    dplyr::right_join(associations$targets,
                      suffix = c("","_remove"),
                      by = c("response" = "target")) %>%
    dplyr::select(-dplyr::ends_with("_remove")) %>%
    suppressMessages()

  # plot
  plot = counts %>%
    ggplot2::ggplot(mapping = ggplot2::aes(label = response,
                                           size = n,
                                           color = !!color_by)) +
      ggwordcloud::geom_text_wordcloud(...) +
      ggplot2::theme_void() +
      ggplot2::facet_grid(cols = dplyr::vars(!!facet_col),
                          rows = dplyr::vars(!!facet_row))

  plot

  }

#' Plot embedding
#'
#' Generate two dimensional plot for \code{associatoR} object.
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import} with targets defined by \link[associatoR]{ar_set_targets}.
#' @param color_by name of variable to generate column facets by.
#' @param color_set a \code{character} string specifying the color set. One of \code{c("A","B","C","D","E","F","G","H")}. See \link[ggplot2]{scale_color_viridis_d}.
#' @param alpha a \code{numeric} value between 0 and 1 specifying the transparency of points. Default is \code{.5}.
#' @param proportion_labels a \code{numeric} value between 0 and 1 specifying the proportion of labels shown in the plot. Values smaller than 1 omit 1-\code{proportion_labels} of labels for lower frequency targets.
#' @param ... optional arguments passed on to \link[ggrepel]{geom_text_repel}.
#'
#' @return Returns a \link[ggplot2]{ggplot} plot object.
#'
#' @examples
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets("cues") %>%
#'   ar_embed_targets() %>%
#'   ar_cluster_targets() %>%
#'   ar_project_embedding() %>%
#'   ar_plot_embedding(color_by = cluster,
#'                     proportion_labels = .5)
#'
#' @export

ar_plot_embedding <- function(associations,
                              color_by = NULL,
                              color_set = "G",
                              alpha = .5,
                              proportion_labels = 1,
                              ...) {

  # checks
  check_object(associations)
  check_targets(associations)
  check_embeddings(associations)

  # capture variables
  color_by = dplyr::enquo(color_by)

  # join
  tbl = associations$targets %>%
    dplyr::left_join(associations$responses, by = c("target" = "response")) %>%
    dplyr::left_join(associations$participants, by = "id") %>%
    dplyr::left_join(associations$cues, by = "cue")

  # count
  emb = associations$responses %>%
    dplyr::count(response) %>%
    dplyr::right_join(associations$targets, by = c("response" = "target")) %>%
    dplyr::right_join(associations$target_embedding, by = c("response" = "target")) %>%
    dplyr::arrange(dplyr::desc(n)) %>%
    suppressMessages()

  pos = (0:nrow(emb))[seq(0, 1, length = nrow(emb)) <= proportion_labels]

  # plot
  plot = emb %>%
    ggplot2::ggplot(mapping = ggplot2::aes(x = dim_1,
                                           y = dim_2,
                                           label = response,
                                           size = n,
                                           color = !!color_by)) +
    ggplot2::geom_point(alpha = alpha) +
    ggrepel::geom_text_repel(data = emb %>% dplyr::slice(pos), ...) +
    ggplot2::theme_void() +
    ggplot2::guides(size = "none", color = "none") +
    ggplot2::scale_size(range = c(0, 6))

  if(!rlang::quo_is_null(color_by)){
    color_var = emb %>% dplyr::pull(!!color_by)
    if(is.character(color_var)){
      plot = plot + ggplot2::scale_color_viridis_d(option = color_set,
                                                   begin = .2, end = .8)
      } else {
      plot = plot + ggplot2::scale_color_viridis_c(option = color_set,
                                                   begin = .2, end = .8)
      }
    }

  plot

}

