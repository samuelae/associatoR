#' Set analysis targets
#'
#' \code{ar_set_target} defines the analysis targets (cues and/or responses).
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import}.
#' @param targets a \code{character} containing either one or both of \code{c("cues","responses")} to gather the targets from these columns or a vector of manually selected targets.
#'
#' @return Returns an \code{associatoR} object containing a list of tibbles:
#' \describe{
#'  \item{participants}{A tibble of participants including a participant \code{id} and potential participant attributes.}
#'  \item{cues}{A tibble of cues including a \code{cue} variable and potential cue attributes.}
#'  \item{responses}{A tibble of responses including a participant id, the cues, the responses, the response level, and additional response attributes.}
#'  \item{targets}{A tibble of targets including the specified analysis target}
#' }
#'
#'
#' @examples
#'
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets(targets = "cues")
#'
#' @export

ar_set_targets <- function(associations,
                           targets = c("cues", "responses")) {

  # checks -----

  # check types
  chk::chk_s3_class(associations, "associatoR")


  # check allowed values
  if(all(targets %in% c("cues", "responses"))){

    # check if type correct
    chk::chk_character(targets)
    chk::chk_subset(targets, c("cues", "responses"))

    # container
    target_vec = c()

    # cues
    if("cues" %in% targets){
      target_vec = c(target_vec, unique(associations$cues$cue))
    }

    # responses
    if("responses" %in% targets){
      target_vec = c(target_vec, unique(associations$responses$response))
    }

    # set unique
    target_vec = unique(target_vec)

    } else {

    # check
    chk::chk_character(targets)

    # use manual
    target_vec = targets
    }

  # out -----

  targets = tibble::tibble(target = target_vec)
  associations$targets <- targets
  associations

  }

#' Count target occurences in responses
#'
#' Append the response \code{frequency} of each target to the \code{targets} table in the \code{associatoR} object.
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import}.
#' @param ... optional \code{logical} comparisons filtering the responses before computing the frequencies.
#'
#' @return Returns an \code{associatoR} object containing a list of tibbles, with \code{targets} gaining a \code{frequency} column:
#' \describe{
#'  \item{participants}{A tibble of participants including a participant \code{id} and potential participant attributes.}
#'  \item{cues}{A tibble of cues including a \code{cue} variable and potential cue attributes.}
#'  \item{responses}{A tibble of responses including a participant id, the cues, the responses, the response level, and additional response attributes.}
#'  \item{targets}{A tibble of targets including a column `frequency` containing counts of this target in the responses.}
#' }
#'
#' @examples
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets(targets = "cues") %>%
#'   ar_count_targets()
#'
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets(targets = "cues") %>%
#'   ar_count_targets(response_position == 1)
#'
#' @export

ar_count_targets <- function(associations, ...) {

  # delay eval
  filters = dplyr::enquos(...)

  # checks
  chk::chk_s3_class(associations, "associatoR")
  chk::chk_subset("targets", names(associations))

  # calc frequency
  frequencies = associations$responses %>%
    dplyr::filter(!!!filters) %>%
    dplyr::group_by(response) %>%
    dplyr::summarize(frequency = dplyr::n())

  # join
  associations$targets = associations$targets %>%
    dplyr::left_join(frequencies, by = c("target" = "response"))

  # handle NAs (in filtered counts)
  associations$targets$frequency[is.na(associations$targets$frequency)] <- 0

  # out
  associations
  }

#' Characterize targets using additional resources
#'
#' Append target characteristics to the \code{targets} table in the \code{associatoR} object. Use pre-defined characteristics from psycho-linguistic research or supply a data.frame as a user-defined look-up table.
#'
#' Data on valence, arousal, and dominance are retrieved from Warriner et al. (2013). Concreteness and word frequency data are retrieved from Brysbaert et al. (2014).
#'
#' @param associations an \code{associatoR} object containing association data as generated by \link[associatoR]{ar_import}.
#' @param characteristics a \code{character} string or vector specifying the characteristic(s) containing one or more from \code{c("valence", "arousal", "dominance", "concreteness", "word_frequency")} or a \code{data.frame} containing characteristics. The \code{data.frame} must contain a column \code{word} to serve as the look up key and may contain additional columns with word characteristics.
#'
#' @return Returns an \code{associatoR} object containing a list of tibbles, with \code{targets} gaining additional columns including the target characteristics:
#' \describe{
#'  \item{participants}{A tibble of participants including a participant \code{id} and potential participant attributes.}
#'  \item{cues}{A tibble of cues including a \code{cue} variable and potential cue attributes.}
#'  \item{responses}{A tibble of responses including a participant id, the cues, the responses, the response level, and additional response attributes.}
#'  \item{targets}{A tibble of targets including the specified analysis targets, and word characteristics}
#' }
#'
#' @references
#' \itemize{
#'   \item{Warriner, A. B., Kuperman, V., & Brysbaert, M. (2013). Norms of valence, arousal, and dominance for 13,915 English lemmas. Behavior Research Methods, 45(4), 1191–1207. https://doi.org/10.3758/s13428-012-0314-x}
#'   \item{Brysbaert, M., Warriner, A. B., & Kuperman, V. (2014). Concreteness ratings for 40 thousand generally known English word lemmas. Behavior Research Methods, 46(3), 904–911. https://doi.org/10.3758/s13428-013-0403-5}
#' }
#'
#'
#'
#'
#' @examples
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets(targets = "cues") %>%
#'   ar_characterize_targets()
#'
#' ar_import(intelligence,
#'           participant = participant_id,
#'           cue = cue,
#'           response = response,
#'           participant_vars = c(gender, education),
#'           response_vars = c(response_position, response_level)) %>%
#'   ar_set_targets(targets = "cues") %>%
#'   ar_characterize_targets(characteristics = data.frame(word = c("intelligence", "brain"),
#'                                                        message = c("Hello", "World")))
#'
#' @export
ar_characterize_targets <- function(associations,
                                    characteristics = c("valence",
                                                        "arousal",
                                                        "dominance",
                                                        "concreteness",
                                                        "word_frequency")) {

  # checks
  chk::chk_s3_class(associations, "associatoR")
  chk::chk_subset("targets", names(associations))
  if(chk::vld_character(characteristics)) {
    chk::chk_subset(characteristics, c("valence","arousal","dominance",
                                       "concreteness","word_frequency"))
  } else if(chk::vld_data(characteristics)) {
    chk::chk_subset("word", names(characteristics))
  } else {
    stop("Object supplied to argument `characteristics` must be a character vector or data.frame.")
  }


  # retrieve valence, arousal, dominance ---

  if(chk::vld_character(characteristics) & any(characteristics %in% c("valence", "arousal","dominance"))) {

    # download from publisher
    name = paste0(tempdir(), "/warriner.zip")
    if(!file.exists(name)){
      download.file("https://static-content.springer.com/esm/art%3A10.3758%2Fs13428-012-0314-x/MediaObjects/13428_2012_314_MOESM1_ESM.zip", name)
      }
    warriner = readr::read_csv(name) %>% suppressMessages()

    # process
    warriner <- warriner %>%
      dplyr::select(word = Word,
                    valence = V.Mean.Sum,
                    arousal = A.Mean.Sum,
                    dominance = D.Mean.Sum) %>%
      dplyr::select(word, any_of(characteristics))

    # add selected characteristics to targets
    associations$targets <- associations$targets %>%
      dplyr::left_join(warriner, by = c("target" = "word"))
  }

  # retrieve concreteness, word_frequency ----

  if(chk::vld_character(characteristics) & any(characteristics %in% c("concreteness", "word_frequency"))) {

    # download from publisher
    name = paste0(tempdir(), "/brysbaert.xlsx")
    if(!file.exists(name)){
      download.file("https://static-content.springer.com/esm/art%3A10.3758%2Fs13428-013-0403-5/MediaObjects/13428_2013_403_MOESM1_ESM.xlsx", name)
      }
    brysbaert <- readxl::read_excel(name)

    # process
    brysbaert <- brysbaert %>%
      dplyr::select(word = Word,
                    concreteness = Conc.M,
                    word_frequency = SUBTLEX) %>%
      dplyr::select(word, any_of(characteristics))

    # add characteristics to targets
    associations$targets <- associations$targets %>%
      dplyr::left_join(brysbaert, by = c("target" = "word"))

  }

  # if specified, add manual target characteristics

  if(chk::vld_data(characteristics)) {

    # add characteristics to targets
    associations$targets <- associations$targets %>%
      dplyr::left_join(characteristics, by = c("target" = "word"))

  }

  # out
  associations

}

